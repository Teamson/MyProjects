{
  "code": "import FdMgr from \"../FanDong/fdMgr\";\r\nimport PlayerDataMgr from \"../Libs/PlayerDataMgr\";\r\nimport WxApi from \"../Libs/WxApi\";\r\nimport SoundMgr from \"../Mod/SoundMgr\";\r\nimport Utility from \"../Mod/Utility\";\r\nimport CameraCrl from \"./CameraCrl\";\r\nimport MoveComponent from \"./MoveComponent\";\r\nimport Player, { AniState } from \"./Player\";\r\nimport Board from \"./Prop/Board\";\r\nimport Heel from \"./Prop/Heel\";\r\nimport Jewel from \"./Prop/Jewel\";\r\nimport Key from \"./Prop/Key\";\r\nimport Obs from \"./Prop/Obs\";\r\nimport Pole from \"./Prop/Pole\";\r\nimport Road from \"./Prop/Road\";\r\nimport RoadFinish from \"./Prop/RoadFinish\";\r\nimport RoadTS from \"./Prop/RoadTS\";\r\nimport RotateBoard from \"./Prop/RotateBoard\";\r\nimport Thorn from \"./Prop/Thorn\";\r\nexport default class GameLogic {\r\n    constructor() {\r\n        this.camStartPos = new Laya.Vector3(0, 0, 0);\r\n        this.camStartRotation = null;\r\n        this._cameraCrl = null;\r\n        this.lightStartAngle = new Laya.Vector3();\r\n        this._levelNode = null;\r\n        this._player = null;\r\n        this._playerCrl = null;\r\n        this._coinCount = 0;\r\n        this._score = 0;\r\n        this.totalDistance = 0;\r\n        this.isDes = false;\r\n        this.startCamField = 80;\r\n        this.isMan = false;\r\n        this.isStartGame = false;\r\n        this.isGameOver = false;\r\n        this.isWin = false;\r\n        this.isPause = false;\r\n        this.isFinish = false;\r\n        if (!Laya.Browser.onWeiXin)\r\n            localStorage.clear();\r\n        GameLogic.Share = this;\r\n        PlayerDataMgr.getPlayerData();\r\n        Laya.Browser.window['wxsdk'].init({\r\n            version: '1.0.0',\r\n            appid: 'wx5b1a2c62d994ea51',\r\n            secret: 'ec0d1ddbbfa81ce293a2bfa497d8d77f',\r\n        });\r\n        FdMgr.init();\r\n        Laya.Scene.open('MyScenes/LoadingUI.scene');\r\n    }\r\n    initScene() {\r\n        Laya.Scene3D.load(WxApi.UnityPath + 'SampleScene.ls', Laya.Handler.create(this, this.onLoadScene));\r\n    }\r\n    onLoadScene(scene) {\r\n        Laya.Scene.open('MyScenes/StartUI.scene');\r\n        this._scene = Laya.stage.addChild(scene);\r\n        Laya.stage.setChildIndex(this._scene, 0);\r\n        this._camera = this._scene.getChildByName('Main Camera');\r\n        this._light = this._scene.getChildByName('Directional Light');\r\n        this._light.shadowMode = Laya.ShadowMode.SoftLow;\r\n        this._light.shadowDistance = 15;\r\n        this._light.shadowResolution = 2048;\r\n        this._light.shadowCascadesMode = Laya.ShadowCascadesMode.NoCascades;\r\n        this.lightStartAngle = this._light.transform.rotationEuler.clone();\r\n        this.camStartPos = this._camera.transform.position.clone();\r\n        this.camStartRotation = this._camera.transform.rotation.clone();\r\n        this._camera.fieldOfView = this.startCamField;\r\n        this._cameraCrl = this._camera.addComponent(CameraCrl);\r\n        this._levelNode = new Laya.Sprite3D();\r\n        this._scene.addChild(this._levelNode);\r\n        this.createPlayer();\r\n        this.createLevel();\r\n    }\r\n    fixCameraField() {\r\n    }\r\n    setFog() {\r\n        let scene = this._scene;\r\n        scene.enableFog = true;\r\n        scene.fogColor = this.getRGB(\"#F17673\");\r\n        scene.fogStart = 0;\r\n        scene.fogRange = 400;\r\n    }\r\n    getRGB(_hexColor) {\r\n        var color = [], rgb = [];\r\n        let hexColor = _hexColor.replace(/#/, \"\");\r\n        if (hexColor.length == 3) {\r\n            var tmp = [];\r\n            for (var i = 0; i < 3; i++) {\r\n                tmp.push(hexColor.charAt(i) + hexColor.charAt(i));\r\n            }\r\n            hexColor = tmp.join(\"\");\r\n        }\r\n        for (var i = 0; i < 3; i++) {\r\n            color[i] = \"0x\" + hexColor.substr(i * 2, 2);\r\n            rgb.push(parseInt(color[i]));\r\n        }\r\n        return new Laya.Vector3(rgb[0] / 255, rgb[1] / 255, rgb[2] / 255);\r\n    }\r\n    gameStart() {\r\n        Laya.Scene.open('MyScenes/GameUI.scene');\r\n    }\r\n    startToWalk() {\r\n        this._playerCrl.playAnimation(AniState.ANI_WALK, 2);\r\n    }\r\n    createLevel() {\r\n        let g = 0;\r\n        if (PlayerDataMgr.getPlayerData().grade <= 10) {\r\n            g = PlayerDataMgr.getPlayerData().grade - 1;\r\n        }\r\n        else {\r\n            g = Math.floor(Math.random() * 5 + 5);\r\n        }\r\n        let dataArr = PlayerDataMgr.levelDataArr[g];\r\n        for (let i = 0; i < dataArr.length; i++) {\r\n            let item = dataArr[i];\r\n            let name = item.name;\r\n            let position = Utility.getVector3(item.position.x, item.position.y, item.position.z);\r\n            let rotation = Utility.getVector3(item.rotation.x, item.rotation.y, item.rotation.z);\r\n            let scale = Utility.getVector3(item.scale.x, item.scale.y, item.scale.z);\r\n            if (name.search('Road_01') != -1) {\r\n                this.createRoad(position, rotation, scale);\r\n            }\r\n            else if (name.search('Pole_01') != -1) {\r\n                this.createPole(position, rotation, scale);\r\n            }\r\n            else if (name.search('Obs_01') != -1) {\r\n                this.createObs(position, rotation, scale);\r\n            }\r\n            else if (name.search('Heel') != -1) {\r\n                this.createHeel(position, rotation, scale);\r\n            }\r\n            else if (name.search('Jewel_01') != -1) {\r\n                this.createJewel(position, rotation, scale);\r\n            }\r\n            else if (name.search('Road_Finish') != -1) {\r\n                this.createRoadFinish(position, rotation, scale);\r\n            }\r\n            else if (name.search('Board_01') != -1) {\r\n                this.createBoard(position, rotation, scale);\r\n            }\r\n            else if (name.search('Road_Ts_01') != -1) {\r\n                this.createRoadTS(position, rotation, scale);\r\n            }\r\n            else if (name.search('Thorn_01') != -1) {\r\n                this.createThorn(position, rotation, scale);\r\n            }\r\n            else if (name.search('Key_01') != -1) {\r\n                this.createKey(position, rotation, scale);\r\n            }\r\n            else if (name.search('Board_02') != -1) {\r\n                this.createBoard2(position, rotation, scale);\r\n            }\r\n        }\r\n        this.createRoad(new Laya.Vector3(0, 0, -20), new Laya.Vector3(), new Laya.Vector3(1, 1, 1));\r\n    }\r\n    createPlayer() {\r\n        this.isMan = PlayerDataMgr.getPlayerData().skinId == 4 || PlayerDataMgr.getPlayerData().skinId == 8 ||\r\n            PlayerDataMgr.getPlayerData().skinId == 11 || PlayerDataMgr.getPlayerData().skinId == 13 || PlayerDataMgr.getPlayerData().skinId == 14;\r\n        let name = this.isMan ? 'Man_01.lh' : 'Wuman_01.lh';\r\n        this._player = Utility.getSprite3DResByUrl(name, this._levelNode);\r\n        this._player.name = 'Player';\r\n        this._playerCrl = this._player.addComponent(Player);\r\n        this._player.addComponent(MoveComponent);\r\n    }\r\n    createRoad(position, rotation, scale) {\r\n        let road = Utility.getSprite3DResByUrl('Road_01.lh', this._levelNode);\r\n        road.transform.position = position;\r\n        road.transform.rotationEuler = rotation;\r\n        road.transform.setWorldLossyScale(scale);\r\n        road.addComponent(Road);\r\n    }\r\n    createObs(position, rotation, scale) {\r\n        let obs = Utility.getSprite3DResByUrl('Obs_01.lh', this._levelNode);\r\n        obs.transform.position = position;\r\n        obs.transform.rotationEuler = rotation;\r\n        obs.transform.setWorldLossyScale(scale);\r\n        obs.addComponent(Obs);\r\n    }\r\n    createPole(position, rotation, scale) {\r\n        let pole = Utility.getSprite3DResByUrl('Pole_01.lh', this._levelNode);\r\n        pole.transform.position = position;\r\n        pole.transform.rotationEuler = rotation;\r\n        pole.transform.setWorldLossyScale(scale);\r\n        pole.addComponent(Pole);\r\n    }\r\n    createThorn(position, rotation, scale) {\r\n        let thorn = Utility.getSprite3DResByUrl('Thorn_01.lh', this._levelNode);\r\n        thorn.transform.position = position;\r\n        thorn.transform.rotationEuler = rotation;\r\n        thorn.transform.setWorldLossyScale(scale);\r\n        thorn.addComponent(Thorn);\r\n    }\r\n    createHeel(position, rotation, scale) {\r\n        let res = Laya.loader.getRes(WxApi.UnityPath + 'ShoesNode.lh');\r\n        let shoes = res.getChildAt(0);\r\n        let heel = Laya.Sprite3D.instantiate(shoes, this._levelNode, false, new Laya.Vector3(0, 0, 0));\r\n        scale = new Laya.Vector3(1.5, 1.5, 1.5);\r\n        heel.transform.position = position;\r\n        heel.transform.rotationEuler = rotation;\r\n        heel.transform.setWorldLossyScale(scale);\r\n        heel.addComponent(Heel);\r\n        let heelNode = Utility.getSprite3DResByUrl('HeelsNode.lh', heel);\r\n        heelNode.transform.localPosition = new Laya.Vector3(0, 0, 0);\r\n    }\r\n    createBoard(position, rotation, scale) {\r\n        let board = Utility.getSprite3DResByUrl('Board_01.lh', this._levelNode);\r\n        board.transform.position = position;\r\n        board.transform.rotationEuler = rotation;\r\n        board.transform.setWorldLossyScale(scale);\r\n        board.addComponent(Board);\r\n    }\r\n    createBoard2(position, rotation, scale) {\r\n        let board = Utility.getSprite3DResByUrl('Board_02.lh', this._levelNode);\r\n        board.transform.position = position;\r\n        board.transform.rotationEuler = rotation;\r\n        board.transform.setWorldLossyScale(scale);\r\n        board.addComponent(RotateBoard);\r\n    }\r\n    createJewel(position, rotation, scale) {\r\n        let jewel = Utility.getSprite3DResByUrl('Jewel_01.lh', this._levelNode);\r\n        jewel.transform.position = position;\r\n        jewel.transform.rotationEuler = rotation;\r\n        jewel.transform.setWorldLossyScale(scale);\r\n        jewel.addComponent(Jewel);\r\n    }\r\n    createKey(position, rotation, scale) {\r\n        let key = Utility.getSprite3DResByUrl('Key_01.lh', this._levelNode);\r\n        key.transform.position = position;\r\n        key.transform.rotationEuler = rotation;\r\n        key.transform.setWorldLossyScale(scale);\r\n        key.addComponent(Key);\r\n    }\r\n    createRoadFinish(position, rotation, scale) {\r\n        let roadFinish = Utility.getSprite3DResByUrl('Road_Finish.lh', this._levelNode);\r\n        roadFinish.transform.position = position;\r\n        roadFinish.transform.rotationEuler = rotation;\r\n        roadFinish.transform.setWorldLossyScale(scale);\r\n        roadFinish.addComponent(RoadFinish);\r\n    }\r\n    createRoadTS(position, rotation, scale) {\r\n        let roadTS = Utility.getSprite3DResByUrl('Road_Ts_01.lh', this._levelNode);\r\n        roadTS.transform.position = position;\r\n        roadTS.transform.rotationEuler = rotation;\r\n        roadTS.transform.setWorldLossyScale(scale);\r\n        roadTS.addComponent(RoadTS);\r\n    }\r\n    winCB() {\r\n        this.isGameOver = true;\r\n        this.isWin = true;\r\n        this.isStartGame = false;\r\n        SoundMgr.instance.playSoundEffect('Victory.mp3');\r\n        Laya.timer.once(2000, this, () => {\r\n            this.showFinishUI();\r\n        });\r\n    }\r\n    loseCB(isFall) {\r\n        WxApi.DoVibrate(false);\r\n        this.isGameOver = true;\r\n        this.isWin = false;\r\n        this.isStartGame = false;\r\n        SoundMgr.instance.playSoundEffect('Lose.mp3');\r\n        Laya.timer.once(2000, this, () => {\r\n            this.showFinishUI();\r\n        });\r\n    }\r\n    showFinishUI() {\r\n        if (PlayerDataMgr.getPlayerData().key < 3) {\r\n            Laya.Scene.open('MyScenes/FinishUI.scene', true);\r\n        }\r\n        else {\r\n            Laya.Scene.open('MyScenes/BoxUI.scene', true);\r\n        }\r\n    }\r\n    activeRoad() {\r\n    }\r\n    restartGame() {\r\n        this.isStartGame = false;\r\n        this.isGameOver = false;\r\n        this.isWin = false;\r\n        this.totalDistance = 0;\r\n        this._score = 0;\r\n        this._coinCount = 0;\r\n        this.isPause = false;\r\n        this._camera.fieldOfView = this.startCamField;\r\n        this.isFinish = false;\r\n        this.isDes = false;\r\n        this._camera.transform.position = this.camStartPos;\r\n        this._camera.transform.rotation = this.camStartRotation;\r\n        this._light.transform.localRotationEuler = this.lightStartAngle;\r\n        this._levelNode.destroyChildren();\r\n        this.createPlayer();\r\n        this.createLevel();\r\n    }\r\n}\r\n",
  "references": [
    "E:/微信项目集合/工程/HighHeels2.10.0/src/FanDong/fdMgr.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Libs/PlayerDataMgr.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Libs/WxApi.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Mod/SoundMgr.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Mod/Utility.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/CameraCrl.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/MoveComponent.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Player.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/Board.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/Heel.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/Jewel.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/Key.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/Obs.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/Pole.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/Road.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/RoadFinish.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/RoadTS.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/RotateBoard.ts",
    "E:/微信项目集合/工程/HighHeels2.10.0/src/Crl/Prop/Thorn.ts"
  ]
}
